-- Generate syntax highlighting for LOVE functions
local api = require 'love-api.love_api'

print([[
" WARNING!
" Do not edit this file!
" It's generated by `build/syntax/lua/main.lua`.
" If you want to change the syntax, edit that file and run `build/gen.dat(sh)`
" it to generate a new version of this file.
]])
-- Generate syntax matching for love.conf
-- TODO:
-- Allow support for variant love.conf = function()
-- (may not work because lua function overrides?)
local function extractDataConf(tab, index)
    local originalconfstr = 'syntax match LoveConf "'
    local confstr = originalconfstr
    local funcstrconf = ""
    for i, v in pairs(tab) do
        if i == 'functions' or i == 'callbacks' then
            if tab.name and (tab.name or ''):sub(1, 1):match('%l') then funcstrconf = funcstrconf ..
                tab.name .. '\\.\\%(' end
            for _, vv in pairs(v) do
                if vv.name == 'conf' then
                    for _, vvv in pairs(vv.variants[1].arguments[1].table) do
                        if vvv.name then
                            confstr = confstr .. '\\%(\\.'
                            if type(vvv) == 'table' then
                                confstr = confstr .. vvv.name .. '\\%('
                                local hasSubs = false
                                for _, vvvv in pairs(vvv.table or {}) do
                                    hasSubs = true
                                    confstr = confstr .. '\\.' .. vvvv.name .. '\\|'
                                end
                                if hasSubs then
                                    confstr = confstr:sub(1, -3) .. '\\)'
                                else
                                    confstr = confstr:sub(1, -4)
                                end
                                confstr = confstr .. '\\>'
                            end
                            confstr = confstr:sub(1, -1) .. '\\)\\|'
                        end
                    end
                    print(confstr:sub(1, -3) .. '"ms=s+1 contains=Lovet containedin=LoveConfRegion,luaFunctionBlock\n')
                end
            end
            if type(v) == 'table' then extractDataConf(v) end
        end
    end
end

local funcstr = ''
local typestr = ''
local callbackstr = ''
local modulestr = ''
local function extractData(tab, index)
    for i, v in pairs(tab) do
        if i == 'functions' or i == 'callbacks' then
            if tab.name and (tab.name or ''):sub(1, 1):match('%l') then
                modulestr = modulestr .. tab.name .. '\\|'
                funcstr = funcstr .. tab.name .. '\\.\\%('
            end
            local func = false
            local typ = false
            local callback = false
            for _, vv in pairs(v) do
                if tab.name then
                    if tab.name:sub(1, 1):match('%l') then
                        func = true
                        funcstr = funcstr .. vv.name .. '\\|'
                    else -- types
                        typ = true
                        typestr = typestr .. vv.name .. '\\|'
                    end
                else
                    callback = true
                    callbackstr = callbackstr .. vv.name .. '\\|'
                end
            end
            if func then
                -- We don't want to be able to have underscores after the word
                funcstr = funcstr:sub(1, -3) .. '\\)\\)\\|\\%('
            end
            if typ then
                -- We don't want to be able to have underscores after the word or highlight the . or :
                typestr = typestr:sub(1, -3) .. '\\)\\|\\%('
            end
            if callback then
                -- We don't want to be able to have underscores after the word
                callbackstr = callbackstr:sub(1, -3) .. '\\)\\|\\%('
            end
        end
        if type(v) == 'table' then extractData(v) end
    end
end

extractData(api)

-- If syntax matches are too long, they are ignored
-- If each function gets individual syntax matches, it runs too slowly
-- Break each group to minimize the number of syntax matches
-- (2500 is an arbitraty limit that seems to work)
local textLimit = 2500
local function limit(text, pre, post)
    while #text > 0 do
        local start, stop = text:sub(1, textLimit):find('.*\\%)\\|')
        local current
        if start then
            current = text:sub(start, stop - 2)
            text = text:sub(stop + 1)
        else
            current = text .. ')'
            text = ''
        end
        print(pre .. current .. post)
    end
end

local containedin = 'containedin=ALLBUT,luaString,luaComment'
print('syntax match Love "\\<love\\>" containedin=LoveModule,LoveFunction,LoveCallback,LoveConfRegion\n')

if #modulestr > 0 then
    local modulePattern = modulestr:sub(1, -3)
    print('syntax match LoveModule "\\<love\\.\\%(' .. modulePattern .. '\\)\\>" contains=Love ' .. containedin .. "\n")
end

limit('\\%(' .. typestr:sub(1, -7), 'syntax match LoveType "[\\:\\.]\\%(', '\\)\\>"ms=s+1 ' .. containedin .. "\n")
limit('\\%(' .. funcstr:sub(1, -7), 'syntax match LoveFunction "\\<love\\.\\%(', '\\)\\>" contains=Love ' .. containedin .. "\n")
limit('\\%(' .. callbackstr:sub(1, -7), 'syntax match LoveCallback "\\<love\\.\\%(', '\\)\\>" contains=Love ' .. containedin .. "\n")

print('syntax region LoveConfRegion start="\\<love\\.conf\\>" end="\\<end\\>"me=e-3,he=e-3,re=e-3 skipwhite skipempty ' .. containedin .. ' contains=ALL\n')

print('syntax match Lovet "\\<t\\>" containedin=LoveConf\n')
extractDataConf(api)

print('execute( "highlight def Love " . g:lovedocs_colors_love )')
print('execute( "highlight def Lovet " . g:lovedocs_colors_love )')
print('execute( "highlight def LoveModule " . g:lovedocs_colors_module )')
print('execute( "highlight def LoveFunction " . g:lovedocs_colors_function )')
print('execute( "highlight def LoveType " . g:lovedocs_colors_type )')
print('execute( "highlight def LoveCallback " . g:lovedocs_colors_callback )')
print('execute( "highlight def LoveConf " . g:lovedocs_colors_conf )')
