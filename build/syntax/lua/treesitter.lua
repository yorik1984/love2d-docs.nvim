-- Generate Treesitter syntax highlighting for LOVE functions

local api = require 'love-api.love_api'

local scm_modules = {}
local scm_types = {}
local scm_callbacks = {}
local scm_conf_keys = {}

local function extractData(tab, path)
    path = path or ''

    for i, v in pairs(tab) do
        if i == 'functions' then
            if tab.name and (tab.name or ''):sub(1, 1):match('%l') then
                if not scm_modules[tab.name] then
                    scm_modules[tab.name] = {}
                end
                for _, func in pairs(v) do
                    table.insert(scm_modules[tab.name], func.name)
                end
            else
                for _, func in pairs(v) do
                    table.insert(scm_types, func.name)
                end
            end
        elseif i == 'callbacks' then
            for _, callback in pairs(v) do
                table.insert(scm_callbacks, callback.name)
            end
        end

        if type(v) == 'table' then
            extractData(v, path .. (tab.name and (tab.name .. '.') or ''))
        end
    end
end

local function extractConfData(tab)
    if tab.callbacks then
        for _, cb in pairs(tab.callbacks) do
            if cb.name == 'conf' then
                local t_arg = cb.variants[1].arguments[1]
                if t_arg and t_arg.table then
                    for _, field in pairs(t_arg.table) do
                        local subkeys = {}
                        if field.table then
                            for _, subfield in pairs(field.table) do
                                table.insert(subkeys, subfield.name)
                            end
                        end
                        scm_conf_keys[field.name] = subkeys
                    end
                end
            end
        end
    end

    for _, v in pairs(tab) do
        if type(v) == 'table' and v.name ~= tab.name then
            extractConfData(v)
        end
    end
end

extractData(api)

extractConfData(api)

local scm_types_str = ''
local scm_callbacks_str = ''
local scm_modules_str = ''

for _, typ in ipairs(scm_types) do
    scm_types_str = scm_types_str .. typ .. '|'
end

for _, callback in ipairs(scm_callbacks) do
    scm_callbacks_str = scm_callbacks_str .. callback .. '|'
end

for module_name, _ in pairs(scm_modules) do
    scm_modules_str = scm_modules_str .. module_name .. '|'
end

if scm_types_str ~= '' then
    scm_types_str = scm_types_str:sub(1, -2)
end

if scm_callbacks_str ~= '' then
    scm_callbacks_str = scm_callbacks_str:sub(1, -2)
end

if scm_modules_str ~= '' then
    scm_modules_str = scm_modules_str:sub(1, -2)
end

local scm_content = [[
; extends

; LOVE framework highlighting for Treesitter

; WARNING!
; Do not edit this file!
; It's generated by `build/syntax/lua/treesitter.lua`
; If you want to change the syntax, edit that file and run `build/gen.dat(sh)`
; it to generate a new version of this file.

]]

scm_content = scm_content
    .. '((dot_index_expression\n'
    .. '  table: (identifier) @variable.global.lua.love)\n'
    .. '  (#eq? @variable.global.lua.love "love")(#set! priority 150))\n\n'
    .. '; Modules\n'
    .. '((dot_index_expression\n'
    .. '  table: (identifier) @_love\n'
    .. '  field: (identifier) @module.bulitin.lua.love)\n'
    .. '  (#eq? @_love "love")\n'
    .. '  (#match? @module.bulitin.lua.love\n'
    .. '    "^(' .. scm_modules_str .. ')$")(#set! priority 150))\n\n'
    .. '; Functions\n'
for module_name, functions in pairs(scm_modules) do
    local funcs_str = ''
    for _, func in ipairs(functions) do
        funcs_str = funcs_str .. func .. '|'
    end
    if funcs_str ~= '' then
        funcs_str = funcs_str:sub(1, -2)
        scm_content = scm_content
            .. '((dot_index_expression\n'
            .. '  table: (dot_index_expression\n'
            .. '    table: (identifier) @_love\n'
            .. '    field: (identifier) @_module)\n'
            .. '  field: (identifier) @function.lua.love)\n'
            .. '  (#eq? @_love "love")\n'
            .. '  (#eq? @_module "' .. module_name .. '")\n'
            .. '  (#match? @function.lua.love\n'
            .. '    "^(' .. funcs_str .. ')$")(#set! priority 150))\n\n'
    end
end

if scm_types_str ~= '' then
    scm_content = scm_content
        .. '; Types\n'
        .. '((dot_index_expression\n'
        .. '  table: (identifier) @_love\n'
        .. '  field: (identifier) @type.lua.love)\n'
        .. '  (#eq? @_love "love")\n'
        .. '  (#match? @type.lua.love\n'
        .. '    "^(' .. scm_types_str .. ')$")(#set! priority 150))\n\n'
        .. '(function_call\n'
        .. '  name: (method_index_expression\n'
        .. '    method: (identifier) @type.lua.love\n'
        .. '    (#match? @type.lua.love "^(' .. scm_types_str .. ')$")(#set! priority 150)))\n\n'
end

if scm_callbacks_str ~= '' then
    scm_content = scm_content
        .. '; Callbacks\n'
        .. '((dot_index_expression\n'
        .. '  table: (identifier) @_love\n'
        .. '  field: (identifier) @function.call.lua.love.callback)\n'
        .. '  (#eq? @_love "love")\n'
        .. '  (#match? @function.call.lua.love.callback\n'
        .. '    "^(' .. scm_callbacks_str .. ')$")(#set! priority 130))\n\n'
end

local conf_scm = "; LOVE conf (t.window, t.modules, etc)\n"
conf_scm = conf_scm
    .. '((dot_index_expression\n'
    .. '  table: (identifier) @variable.global.lua.love)\n'
    .. '  (#eq? @variable.global.lua.love "t")(#set! priority 150))\n\n'
for key, subkeys in pairs(scm_conf_keys) do
    -- t.window
    conf_scm = conf_scm ..
        "((dot_index_expression\n" ..
        "  table: (identifier) @_t\n" ..
        "  field: (identifier) @function.call.lua.love.conf)\n" ..
        "  (#eq? @_t \"t\")\n" ..
        "  (#eq? @function.call.lua.love.conf \"" .. key .. "\")(#set! priority 150))\n\n"

    -- t.window.title
    if #subkeys > 0 then
        local sub_str = table.concat(subkeys, "|")
        conf_scm = conf_scm ..
            "((dot_index_expression\n" ..
            "  table: (dot_index_expression\n" ..
            "    table: (identifier) @_t\n" ..
            "    field: (identifier) @_prop)\n" ..
            "  field: (identifier) @function.call.lua.love.conf)\n" ..
            "  (#eq? @_t \"t\")\n" ..
            "  (#eq? @_prop \"" .. key .. "\")\n" ..
            "  (#match? @function.call.lua.love.conf \"^(" .. sub_str .. ")$\")(#set! priority 150))\n\n"
    end
end

scm_content = scm_content .. conf_scm

print(scm_content)
